# 中药列表页
HERB_LIST_HTML = '''
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中药大全 - 智能中草药识别</title>
    <style>
        * {margin:0; padding:0; box-sizing:border-box; font-family:"微软雅黑";}
        body {background:#f8f9fa;}
        .nav {background:#3498db; padding:15px 0; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .nav-inner {max-width:1200px; margin:0 auto; padding:0 20px; display:flex; justify-content:space-between; align-items:center;}
        .logo {color:white; font-size:24px; font-weight:bold;}
        .nav-menu a {color:white; text-decoration:none; margin-left:20px; font-size:16px;}
        .container {max-width:1200px; margin:30px auto; padding:0 20px;}
        .title {text-align:center; color:#2c3e50; margin-bottom:30px; font-size:28px;}
        .title::after {content:""; display:block; width:80px; height:3px; background:#3498db; margin:10px auto;}
        .herb-grid {display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:20px;}
        .herb-item {background:white; border-radius:10px; padding:20px; box-shadow:0 5px 10px rgba(0,0,0,0.05); transition:all 0.3s;}
        .herb-item:hover {transform:translateY(-5px); box-shadow:0 8px 15px rgba(0,0,0,0.1);}
        .herb-img {width:100%; height:200px; border-radius:8px; object-fit:cover; margin-bottom:15px;}
        .herb-name {font-size:20px; color:#2c3e50; margin-bottom:10px; font-weight:bold;}
        .herb-desc {font-size:16px; line-height:1.6; color:#666;}
        .footer {background:#2c3e50; color:white; text-align:center; padding:20px 0; margin-top:50px;}
    </style>
</head>
<body>
    <div class="nav">
        <div class="nav-inner">
            <div class="logo">智能中草药识别</div>
            <div class="nav-menu">
                <a href="/">首页识别</a>
                <a href="/herb-list">中药大全</a>
                <a href="/about">使用说明</a>
            </div>
        </div>
    </div>

    <div class="container">
        <h2 class="title">中草药大全（50种常见药材）</h2>
        <div class="herb-grid">
            {% for herb, info in herb_db.items() %}
                <div class="herb-item">
                    <img src="/static/images/{{herb}}.jpg" class="herb-img" onerror="this.src='/static/images/default.jpg'">
                    <div class="herb-name">{{herb}}</div>
                    <div class="herb-desc"><strong>药效：</strong>{{info.药效[:50]}}...</div>
                    <div class="herb-desc"><strong>用法：</strong>{{info.日常用法[:30]}}...</div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="footer">
        智能中草药识别工具 © 2026 版权所有
    </div>
</body>
</html>
'''


# 首页路由（智能识别）
@app.route("/", methods=["GET", "POST"])
def index():
    res = None
    herb_list = list(HERB_ALIAS.keys())[:20]  # 显示前20种中药
    if request.method == "POST" and "file" in request.files:
        file = request.files["file"]
        if file.filename:
            # 保存上传的图片
            img_path = os.path.join(UPLOAD_DIR, file.filename)
            file.save(img_path)
            # 调用AI识别
            herb_name = ai_recognize_img(img_path)
            if herb_name:
                herb_db = load_db()
                res = {"status": "success", "herb": herb_name, "info": herb_db.get(herb_name, {})}
            else:
                res = {"status": "fail", "msg": "未识别到中草药，请上传清晰的药材图片"}
    return render_template_string(INDEX_HTML, res=res, herb_list=herb_list)


# 中药列表页路由
@app.route("/herb-list")
def herb_list():
    herb_db = load_db()
    return render_template_string(HERB_LIST_HTML, herb_db=herb_db)


# 新增：处理about页面（避免访问/about时报404）
@app.route("/about")
def about():
    return '''
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>使用说明 - 智能中草药识别</title>
        <style>
            * {margin:0; padding:0; box-sizing:border-box; font-family:"微软雅黑";}
            body {background:#f8f9fa;}
            .nav {background:#3498db; padding:15px 0; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
            .nav-inner {max-width:1200px; margin:0 auto; padding:0 20px; display:flex; justify-content:space-between; align-items:center;}
            .logo {color:white; font-size:24px; font-weight:bold;}
            .nav-menu a {color:white; text-decoration:none; margin-left:20px; font-size:16px;}
            .container {max-width:800px; margin:30px auto; padding:0 20px; background:white; border-radius:15px; padding:30px; box-shadow:0 5px 15px rgba(0,0,0,0.05);}
            .title {text-align:center; color:#2c3e50; margin-bottom:30px; font-size:28px;}
            .title::after {content:""; display:block; width:80px; height:3px; background:#3498db; margin:10px auto;}
            .desc {font-size:18px; line-height:2; color:#333; margin-bottom:20px;}
            .footer {background:#2c3e50; color:white; text-align:center; padding:20px 0; margin-top:50px;}
        </style>
    </head>
    <body>
        <div class="nav">
            <div class="nav-inner">
                <div class="logo">智能中草药识别</div>
                <div class="nav-menu">
                    <a href="/">首页识别</a>
                    <a href="/herb-list">中药大全</a>
                    <a href="/about">使用说明</a>
                </div>
            </div>
        </div>
        <div class="container">
            <h2 class="title">使用说明</h2>
            <div class="desc">1. 点击首页的上传区域，选择清晰的中草药图片（支持jpg/png格式）；</div>
            <div class="desc">2. 点击「开始智能识别」按钮，等待系统调用AI接口识别药材；</div>
            <div class="desc">3. 识别成功后会显示药材的药效、药用部位、用法和禁忌；</div>
            <div class="desc">4. 可在「中药大全」页面查看常见中草药的基础信息。</div>
        </div>
        <div class="footer">
            智能中草药识别工具 © 2026 版权所有
        </div>
    </body>
    </html>
    '''